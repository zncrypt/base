# Шифрование

* Клиент: Генерация случайного числа для подписи публичного ключа
* Клиент: Запрос публичного ключа сервера
* Сервер: Отправка публичного ключа клиенту
* Клиент: Проверка подлинности публичного ключа сервера
* Клиент: Отправка команды старт сессии
* Сервер: генерация ID сессии и отправка клиенту
* Клиент: Генерация секретного ключа и MAC
* Клиент: Шифрование секретного ключа и MAC публичным ключом сервера
* Клиент: Отправка зашифрованного секретного ключа и MAC на сервер
* Сервер: Расшифровка серкретного ключа и MAC своим приватным ключом
* Сервер: Сохранение секретного ключа в хранилище сессии
* Сервер: Шифровние команды "готов к шифрованному соединению" серкретным ключом
* Сервер: Отправка шифрованной команды клиенту
* Клиент: Расшифровка команды
* Клиент: Шифровние команды "готов к шифрованному соединению" серкретным ключом
* Клиент: Отправка шифрованной команды серверу
* Клиент и сервер переходят в режим защищенного соединения

## Обмен общим ключом шифрования

Генерируется случайное число и отправляется серверу (hello server).
Сервер подписывает скоп данных:
 
* сертификат
* случайное число клиента
* генерирует ID сессии

и отправляет клиенту. Генерация случайных чисел нужна для того, чтобы Алиса не смогла отправить эту команду повторно от имени клиента.

Клиент

* верифицирует подпись данных:
    * сертификат
    * свое случайное число
    * ID сессии
* проверяет полученное случайное число
* проверяет подлинность сертификата с помощью корневого сертификата
* сохраняет ID сессии
* сохраняет публичный ключ сервера

Как только мы убедились, что сервер подлинный, можно генерировать общий секретный ключ и MAC.

Клиент генерирует общий секретный ключ и MAC.
Далее, шифрует публичным ключом сервера следующие данные:

* общий секретный ключ
* MAC
* ID сессии

Сервер

Расшифровывает скоп данных:

* общий секретный ключ
* MAC
* ID сессии

Сохраняет в сессию данные:

* общий секретный ключ
* MAC

и посылает клиенту зашифрованную команду "готов к переходу на шифрованное соединение".

Клиент

* расшифровывает команду готовности сервера
* шифрует свою команду готовности и отправляет серверу

Сервер расшифровывает команду готовности клиента.

Переход к шифрованному соединению.

## Шифрованное соединение

Клиент передает в заголовке ID сессии и зашифрованный контент в теле.

Сервер получает секретный ключ по ID сессии и расшифровывает данные клиента.
Ответ шифруется секретным ключом и отправляется клиенту.

Все запросы и ответы шифруются общим серкретным ключом и добавляется MAC-хэш для проверки целостности.

## Сквозное шифрование P2P

Сертификаты должны иметь оба клиента.

Сертификат сервера при этом не имеет значения.

